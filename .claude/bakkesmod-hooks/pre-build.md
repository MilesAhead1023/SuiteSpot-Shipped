# hook pre-build (BakkesMod)

Execute pre-build validations specific to BakkesMod plugin compilation.

## Usage

```bash
npx claude-flow hook pre-build --project bakkesmod
```

## Options

- `--check-sdk` - Verify BakkesMod SDK installation (default: true)
- `--validate-vcxproj` - Check project configuration (default: true)
- `--check-version` - Ensure version.h exists and is valid (default: true)
- `--verify-toolchain` - Confirm Visual Studio 2022 toolchain (default: true)
- `--check-dependencies` - Validate vcpkg dependencies (default: true)

## Validation Checks

### 1. BakkesMod SDK Installation

Checks for BakkesMod SDK via registry:

```powershell
# Registry key: HKEY_CURRENT_USER\Software\BakkesMod\AppPath@BakkesModPath
# Expected: %APPDATA%\bakkesmod\bakkesmod
```

**Required files:**
- `bakkesmodsdk/include/*.h`
- `bakkesmodsdk/lib/pluginsdk.lib`
- `bakkesmodsdk/bakkesmod-patch.exe`

### 2. Project Configuration Validation

Verifies `SuiteSpot.vcxproj`:

- **Platform**: x64 only
- **Toolset**: v143 (Visual Studio 2022)
- **C++ Standard**: stdcpp20
- **Runtime Library**: MultiThreaded (Release)
- **BakkesMod.props**: Imported correctly

### 3. Version File Check

Ensures `version.h` contains:

```cpp
#define VERSION_MAJOR 1
#define VERSION_MINOR 0
#define VERSION_PATCH 0
#define VERSION_BUILD <auto-incremented>
#define VERSION_BUILD_TIMESTAMP <auto-generated>
```

### 4. Visual Studio Toolchain

Confirms MSVC v143 toolset is installed:

```bash
# Check for cl.exe in VS 2022 path
# Expected: C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Tools\MSVC\14.3x\bin\Hostx64\x64\cl.exe
```

### 5. Dependency Validation

Checks vcpkg dependencies:

- **nlohmann-json**: `C:\Users\<user>\vcpkg\installed\x64-windows\include\nlohmann\json.hpp`
- **ImGui**: Bundled in `IMGUI/` directory

## Pre-Build Script Execution

Verifies `CompiledScripts/update_version.ps1` exists and can run:

```powershell
# This script auto-increments VERSION_BUILD
powershell.exe -ExecutionPolicy Bypass -NoProfile -NonInteractive -File CompiledScripts/update_version.ps1 "./version.h"
```

## Output

Returns JSON with validation results:

```json
{
  "continue": true,
  "sdkInstalled": true,
  "sdkPath": "C:\\Users\\bmile\\AppData\\Roaming\\bakkesmod\\bakkesmod",
  "vcxprojValid": true,
  "versionFileExists": true,
  "toolchainValid": true,
  "dependencies": {
    "nlohmann-json": true,
    "imgui": true
  },
  "warnings": [],
  "errors": []
}
```

## Common Issues

### BakkesMod SDK Not Found

**Error**: Registry key missing or SDK path invalid

**Solution**:
1. Install BakkesMod from https://bakkesmod.com
2. Launch BakkesMod at least once to create registry entries
3. Verify `%APPDATA%\bakkesmod\bakkesmod\bakkesmodsdk` exists

### vcpkg Dependency Missing

**Error**: nlohmann-json not found

**Solution**:
```bash
cd C:\Users\<user>\vcpkg
.\vcpkg install nlohmann-json:x64-windows
```

### Visual Studio 2022 Not Installed

**Error**: MSVC v143 toolset not found

**Solution**:
1. Install Visual Studio 2022 Community
2. Select "Desktop development with C++"
3. Ensure C++20 support is installed

## Integration

This hook is automatically called by Claude Code when:

- Building the project via `msbuild` or Visual Studio
- Before any compilation operation
- After modifying build configuration files

Manual usage:

```bash
# Validate before building
npx claude-flow hook pre-build --project bakkesmod

# If validation passes:
msbuild SuiteSpot.sln /p:Configuration=Release /p:Platform=x64
```

## See Also

- `hook post-build` - Post-build validation
- `hook project-init` - Project setup validation
- [CLAUDE.md](../../CLAUDE.md) - Build commands
- [BakkesMod.props](../../BakkesMod.props) - SDK property sheet
